-- CREATE DATABASE DemoDB

USE [DemoDB]
GO

DROP TABLE IF EXISTS T_Emp
GO
DROP TABLE IF EXISTS T_Emp2
GO

CREATE TABLE T_Emp(
	ID int NOT NULL, 
	Name Varchar(20), 
	Status Varchar(1), 
	Flag tinyint NOT NULL, 
	UpdDate Datetime, 
	CONSTRAINT PK_T_Emp PRIMARY KEY CLUSTERED(ID)) 
GO

CREATE TABLE T_Emp2(
	ID int NOT NULL, 
	Name Varchar(20), 
	Status Varchar(1), 
	Flag tinyint NOT NULL, 
	UpdDate Datetime, 
	CONSTRAINT PK_T_Emp2 PRIMARY KEY CLUSTERED(ID)) 
GO

CREATE INDEX IX_Name on T_Emp(Name)
CREATE INDEX IX_Status on T_Emp(Status)
CREATE INDEX IX_Flag on T_Emp(Flag)
CREATE INDEX IX_UpdDate on T_Emp(UpdDate)
GO

CREATE INDEX IX_Name on T_Emp2(Name)
CREATE INDEX IX_Status on T_Emp2(Status)
CREATE INDEX IX_Flag on T_Emp2(Flag)
CREATE INDEX IX_UpdDate on T_Emp2(UpdDate)
GO

TRUNCATE TABLE T_Emp
TRUNCATE TABLE T_Emp2
GO

-- 10 件データを登録
SET NOCOUNT ON
GO

DECLARE @i int = 1
DECLARE @name varchar(10)

WHILE @i <= 10
	BEGIN SET @name = 'Name' + RIGHT('000000'+ CONVERT(VARCHAR,@i),6)
	INSERT INTO T_Emp VALUES( @i,@name,1,RAND() * 10 ,Getdate() )
	SET @i += 1
END
GO

-- 10 件の状態の統計情報を取得
UPDATE STATISTICS T_Emp IX_Flag WITH FULLSCAN
DBCC SHOW_STATISTICS ('T_Emp', 'IX_Flag') WITH STATS_STREAM
GO

--  100 万件までデータを増幅
SET NOCOUNT ON
GO

DECLARE @i int = 11
DECLARE @name varchar(10)
BEGIN TRAN
WHILE @i <= 1000000
BEGIN
	SET @name = 'Name' + RIGHT('000000'+ CONVERT(VARCHAR,@i),6)
	INSERT INTO T_Emp VALUES( @i,@name,2,RAND() * 10,Getdate() )
	SET @i += 1
END
COMMIT TRAN
GO

-- 100 万件の状態の統計情報の STATS STREAM を取得
UPDATE STATISTICS T_Emp IX_Flag WITH FULLSCAN
DBCC SHOW_STATISTICS ('T_Emp', 'IX_Flag') WITH STATS_STREAM 
GO

INSERT INTO T_Emp2 SELECT * FROM T_Emp
GO

ALTER TABLE T_Emp REBUILD 
GO

ALTER TABLE T_Emp2 REBUILD 
GO

/*
-- 10 件の統計情報
UPDATE STATISTICS T_Emp(IX_Flag) WITH STATS_STREAM = 0x010000000200000000000000000000002B1CE23900000000E00100000000000088010000000000003003000030000000010003000000000000000000DE0100003803FFFF3800000004000A000000000000000000020000000700000083CFCD0061A700000A000000000000000A00000000000000000000000000803FCDCCCC3D00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000100000002000000110000000000A04000002041000000000000803F0000804000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000110000000000000000000000000000001C00000000000000240000000000000008000000000000001000110000002041000000000000803F000400000A00000000000000

-- 100 万件の統計情報
UPDATE STATISTICS T_Emp(IX_Flag) WITH STATS_STREAM = 0x01000000020000000000000000000000FE816841000000005402000000000000FC010000000000003003C4C630000000010003000000000000000000DE0100003803C4C63800000004000A0000000000000000000000000007000000FFFBCD0061A7000040420F000000000040420F0000000000000000000000003FBD37863500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000200000002000000110000000000A04000247449000000000000803F000080400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000380000000000000088000000000000009000000000000000100000000000000024000000000000001000110000002041000000000000803F000400001000110060237449000000000000803F010400000100000083CFCD0061A7000000000000000024400A0000000000000001000000000000000000F03F000000006C842E410000000000000000000000006C842E410000000000000000D7123F928FA0F63F40420F0000000000
*/

/*
-- 実行プランを変化させるためのインデックス
DROP INDEX IF EXISTS IX_Flag2 ON T_Emp
CREATE INDEX IX_Flag2 on T_Emp(Flag)  INCLUDE(Name, Status,UpdDate)
*/

