DROP TRIGGER IF EXISTS trg_T1
DROP TABLE IF EXISTS T1
DROP TABLE IF EXISTS TrgT1
DROP FUNCTION IF EXISTS uf_GETJPDATE
DROP PROCEDURE IF EXISTS usp_T1
GO

CREATE FUNCTION uf_GETJPDATE()
RETURNS datetime2
AS
BEGIN
	RETURN DATEADD(hour,9,GETUTCDATE())
END
GO

CREATE TABLE T1 (
	C1 int identity,
	C2 uniqueidentifier,
	C3 datetime2 DEFAULT(dbo.uf_GETJPDATE()),
	CONSTRAINT PK_T1 PRIMARY KEY (C1)
)

SELECT * INTO TrgT1 FROM T1 WHERE 0=0
GO

CREATE TRIGGER trg_T1 ON T1
AFTER INSERT
AS
	SET IDENTITY_INSERT TrgT1 ON
	DECLARE @datetime datetime2 = (SELECT GETDATE())
	INSERT INTO TrgT1 (C1, C2, C3) SELECT C1, C2, @datetime FROM inserted
GO

CREATE PROCEDURE usp_T1
	@ret int OUTPUT
AS
BEGIN
	SET NOCOUNT ON;
	SET IDENTITY_INSERT TrgT1 ON
	INSERT INTO T1(C2) VALUES(NEWID())
	SET @ret = (SELECT COUNT(*) FROM T1)
END
GO

DBCC FREEPROCCACHE
GO

DECLARE @ret int
INSERT INTO T1(C2) VALUES(NEWID())
SELECT * FROM T1
SELECT * FROM TrgT1
EXEC usp_T1 @ret OUT
SELECT @ret
GO
